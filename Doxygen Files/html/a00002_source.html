<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACES HCU: HCU_Funcs.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ACES HCU
   &#160;<span id="projectnumber">1.1</span>
   </div>
   <div id="projectbrief">This is the code to operate the Heating Control Unit.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a00002_source.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">HCU_Funcs.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="a00002.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#define F_CPU 1000000UL   // This is so that the delay functions work.  Sets clock to 1MHz</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="a00005.html">HCU_Funcs.h</a>&quot;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;avr/io.h&gt;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &lt;util/delay.h&gt;</span>   <span class="comment">// This library is so that easy delay functions can be implemented</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;avr/interrupt.h&gt;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;float.h&gt;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="a00005.html#a23459ced73501cbafb717ca9cbb10ce7">   36</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a00002.html#a23459ced73501cbafb717ca9cbb10ce7">Initial</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;{</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">// First setup the port directions for the PWM lines and the</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="comment">// 0 are inputs 1 are outputs</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    DDRA = 0b10000000;          <span class="comment">// Only PA7 is an output</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    DDRB = 0b11011010;         </div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    DDRC = 0xFF;                <span class="comment">// Make all outputs</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    DDRD = 0xFF;                <span class="comment">// Make all outputs</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    </div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    cur_ADC = 0;     <span class="comment">// This is for ADC0    </span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    opMode = 0;     <span class="comment">// This sets the function mode to heating mode</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    desired_temp = 0;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    duty_cycle = (pump_m*fuelFlow + pump_b) / pump_tot_V;    <span class="comment">// This is the initial guess for the fuel pump</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    </div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="comment">// Now calculate the number of pulses I expect per 0.262144 seconds (max time for an 8 bit timer with prescalar of 1024)</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="keywordtype">float</span> pulse_flow = (fuelFlow / density) * K_factor * max_time / 1000;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    desired_pulses = (uint8_t) pulse_flow;     <span class="comment">// round down and convert to an 8 bit number.  I expect it to be 170 so it will fit.</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    pulse_error_allow = (uint8_t)(desired_pulses * (fuelError / fuelFlow));   </div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;MCUCSR,ISC2,1);      <span class="comment">// This will cause interrupts for INT2 to be caused on the rising edge</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;GIFR, INTF2, 1);     <span class="comment">// Make sure the interrupt flag is cleared</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    </div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    </div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">// Configure the ADC</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    ADCSRA |= 1 &lt;&lt; ADPS2;   <span class="comment">// This is so there is a prescalar of 16.  ADC needs frequency between 50-200kHz so 1,000,000/16 puts it in this range.</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    ADCSRA |= 1 &lt;&lt; ADEN;    <span class="comment">// Enable the ADC</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    ADMUX |= 1 &lt;&lt; REFS0;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    sei();       <span class="comment">// This sets the global interrupt flag to allow for hardware interrupts</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    </div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">// Now enable the timer1 for 0.5 sec</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    TIMSK |= 1 &lt;&lt; TOIE1;   <span class="comment">// turn on overflow interrupts</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    TCCR1B |= (1&lt;&lt;CS11);    <span class="comment">// This has a prescalar of 8</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    TCNT1 = 3036;   <span class="comment">// This will load the value so that when using a prescalar of 8, it will overflow after 500ms</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    </div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    saveTemps[0] = -100.0;        <span class="comment">// Assign initial temperature values that for sure will be colder than the specified temps </span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    saveTemps[1] = -100.0;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    saveTemps[2] = -100.0;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    saveTemps[3] = -100.0;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    saveTemps[4] = -100.0;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    saveTemps[5] = -100.0;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    saveTemps[6] = -100.0; </div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    </div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">// Now I need to turn on all of the heaters as well as set the duty cycles for the PWMs which will be on timers 0 and 2</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">// Start with the PWM for the ECU, this will be on timer0</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    TCNT0 = 0;      </div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0, WGM01, 1);</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0, WGM00, 1);      <span class="comment">// These two set the PWM Mode to &quot;Fast PWM&quot;</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0, COM01, 1); </div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0, COM00, 1);      <span class="comment">// These two set the PWM type to inverting PWM</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    </div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    OCR0 = 255 - (255*ECU_duty);       <span class="comment">// This will set it to the specified duty by the #define</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    </div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    TCCR0 |= (1 &lt;&lt; CS02);              <span class="comment">// This will start the PWM with a duty cycle of 65.536 ms</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    </div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">// Now do the PWM for the second fuel line which will use Timer 2,  this will look very similar to the last few lines of code</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    TCNT2 = 0;      <span class="comment">// Clear the timer register to make sure I have the full range on the first cycle</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR2, WGM21, 1);</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR2, WGM20, 1);      <span class="comment">// These two set the PWM Mode to &quot;Fast PWM&quot;</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR2, COM21, 1);</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR2, COM20, 1);      <span class="comment">// These two set the PWM type to inverting PWM</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        </div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    OCR2 = 255 - (255*F_line_duty);       <span class="comment">// This will set it to the specified duty by the #define</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        </div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    TCCR2 |= (1 &lt;&lt; CS22);              <span class="comment">// This will start the PWM with a duty cycle of 65.536 ms, just like before</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    </div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="comment">// Now turn on all the other heaters</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, BatPin, 1);</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, HopperPin, 1);</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, FLine1Pin, 1);</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, ESB_Pin, 1);     <span class="comment">// I can omit doing this for the ECU and FuelLine1</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        </div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;}</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00122"></a><span class="lineno"><a class="line" href="a00002.html#ab16889ae984b9b798989a0d239283cac">  122</a></span>&#160;<a class="code" href="a00002.html#ab16889ae984b9b798989a0d239283cac">ISR</a>(TIMER1_OVF_vect)</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;{</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">// The LED is on PD5</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    alive_counter++;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> (alive_counter % 2 == 1)</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        PORTD ^= (1 &lt;&lt; Alive_LED);</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        </div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    PORTB ^= (1 &lt;&lt; Warm_LED);   <span class="comment">// This will have the warming LED blink 0.5 sec on 0.5 sec off and the alive LED blinking twice as slow</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    </div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment">// Now reset the register</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    TCNT1 = 3036;  <span class="comment">// The interrupt will clear automatically when this function is called</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;}</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno"><a class="line" href="a00005.html#ab42f8654f10b780bd735bb55bd53d60d">  153</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a00002.html#ab42f8654f10b780bd735bb55bd53d60d">tempConversion</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;{</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// First check if the ADC is done converting</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;ADMUX,MUX0,0);    <span class="comment">// Assign channel to 0</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;ADMUX,MUX1,0);</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;ADMUX,MUX2,0);</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    </div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i = 0; i &lt; 6; i++)</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    {</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        ADCSRA |= 1 &lt;&lt; ADSC;   </div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="keywordflow">while</span> (!((1 &lt;&lt; ADIF) &amp; ADCSRA));</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        </div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="keywordflow">while</span> (<a class="code" href="a00005.html#ad188fb0fbfd923bdb01294072367d024">bit_is_clear</a>(ADCSRA, ADIF));                <span class="comment">// Hog execution until the ADC is done converting</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <span class="comment">// Save this as a float for the respective variable</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        uint8_t low_bits = ADCL;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        uint8_t high_bits = ADCH;                          <span class="comment">// Do the shifting so that there is room made inside of the 16 bit register</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        uint16_t result = (high_bits &lt;&lt; 8) | low_bits;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        </div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="comment">// Now I need to convert this 16 bit number into an actual temperature</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        </div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        act_temp = (float)(0.0048828125*result);           <span class="comment">// This dumb thing converts it to a voltage</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        act_temp = act_temp*208.8 - 79.6;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        saveTemps[i] = act_temp;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        </div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="comment">// Now update the channel the ADC is using</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;ADMUX,MUX0,(i + 1) &amp; 0x01);           <span class="comment">// Assign bit 0</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;ADMUX,MUX1,((i + 1) &gt;&gt; 1) &amp; 0x01);    <span class="comment">// Assign bit 1</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;ADMUX,MUX2,((i + 1) &gt;&gt; 2) &amp; 0x01);    <span class="comment">// Assign bit 2</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        </div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;ADCSRA, ADIF, 1);     <span class="comment">// write a logical 1 to clear the flag, page 216 in the data sheet</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    }</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <a class="code" href="a00002.html#a7eb1892912f647fc11a82891ac8b0408">tempHeaterHelper</a>();             <span class="comment">// Call the helper function.  This will serve the added bonus of killing some time so that if capacitors need to charge for the next conversion, it has the time here.  Data sheet didn&#39;t say that it needed this though.</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    _delay_ms(250);                 <span class="comment">// Delay for 1/4 of a second.   Need to check that the Alive LED will still interrupt properly</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    </div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;}</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00208"></a><span class="lineno"><a class="line" href="a00005.html#a7eb1892912f647fc11a82891ac8b0408">  208</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a00002.html#a7eb1892912f647fc11a82891ac8b0408">tempHeaterHelper</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;{</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; 6; i++)</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    {</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keywordflow">switch</span>(i){</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            <span class="keywordflow">case</span> 0:       </div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                <span class="keywordflow">if</span> (saveTemps[0] &gt; TempBat )    </div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                {</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                    desired_temp |= 0x01;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, BatPin, 0);       </div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                }</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(saveTemps[0] &lt; TempBat)</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                {</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, BatPin, 1);    <span class="comment">// Turn the heater back on to warm them up</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                }</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                </div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <span class="keywordflow">case</span> 1:       </div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                <span class="keywordflow">if</span> (saveTemps[2] &lt; TempHopper)   </div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, HopperPin, 1);</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(saveTemps[2] &gt; TempHopper)</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                {</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, HopperPin, 0);   </div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                    desired_temp |= 0x02;               </div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                }</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                </div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="keywordflow">case</span> 2:       </div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                <span class="keywordflow">if</span> (saveTemps[3] &lt; TempECU)</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                    <span class="keywordflow">if</span> (!opMode)</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0, CS02, 1);      </div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                    <span class="keywordflow">else</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTB, ECU_pin, 1);   </div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (saveTemps[3] &gt; TempECU)</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                {</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                    <span class="keywordflow">if</span> (!opMode)</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                    {</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0, CS02, 0);      </div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                        desired_temp |= 0x04;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                    }</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                    <span class="keywordflow">else</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTB, ECU_pin, 0);   </div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                }</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                </div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            <span class="keywordflow">case</span> 3:       </div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="keywordflow">if</span> (saveTemps[4] &lt; TempFLine1)</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, FLine1Pin, 1);</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(saveTemps[4] &gt; TempFLine1)</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                {</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, FLine1Pin, 0);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                    desired_temp |= 0x08;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                }</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                </div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            <span class="keywordflow">case</span> 4:       </div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                <span class="keywordflow">if</span> (saveTemps[5] &lt; TempFLine2){</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                    <span class="keywordflow">if</span> (!opMode)      </div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR2, CS22, 1);       </div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                    <span class="keywordflow">else</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD,Fline2Pin,1);       </div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                }</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (saveTemps[5] &gt; TempFLine2)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                {</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                    <span class="keywordflow">if</span> (!opMode)           </div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                    {</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR2, CS22, 0);       </div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                        desired_temp |= 0x10;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                    }</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                    <span class="keywordflow">else</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, Fline2Pin, 0);    </div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                }</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                </div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            <span class="keywordflow">case</span> 5:       </div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                <span class="keywordflow">if</span> (saveTemps[5] &lt; TempESB)</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, ESB_Pin, 1);</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(saveTemps[6] &gt; TempESB)</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                {</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, ESB_Pin, 0);</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                    desired_temp |= 0x20;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                }</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        }</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        </div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    }</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    </div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="keywordflow">if</span> (desired_temp == 0x3F)      </div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    {</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="keywordflow">if</span> (!opMode)    </div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            <a class="code" href="a00002.html#af224025ba48225a48fc9eddc2e72150d">change_timers</a>();                     </div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    }</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;}</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00324"></a><span class="lineno"><a class="line" href="a00005.html#a560b1b76f46bf0b687417029801fd05a">  324</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a00002.html#a560b1b76f46bf0b687417029801fd05a">flowMeter</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;{</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="comment">// First I need to enable interrupt on INT2</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    pulse_count = 1;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    GICR |= (1 &lt;&lt; INT2);     </div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="comment">// Second I need to begin timer2</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    </div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    TCNT0 = 0;                     <span class="comment">// Make sure the timer/counter register is cleared so the full range can be used</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TIFR,TOV1,1);     <span class="comment">// Make sure the overflow flag is set</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0,CS02,1);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0,CS01,0);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0,CS00,1);     <span class="comment">// TThis will start the timer with a prescalar of 1024</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    </div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">while</span> (!(TIFR &amp; 0x01));        <span class="comment">// Hog the execution until the overflow flag is set</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    </div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;GICR, INT2, 0);    <span class="comment">// disable external interrupts for INT2</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        </div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keywordflow">if</span> (!pulse_count)              <span class="comment">// There is either no more fuel or there is a stoppage.  This if statement might be the end of me...</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    {</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        opMode = 2;    </div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR1B, CS10, 0);              <span class="comment">// This should stop the PWM for the pump</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, Alive_LED, 1);</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTD, Fuel_LED, 1);</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTB, Warm_LED, 1);    <span class="comment">// Make sure all of the LEDs are solid on to signify the end of the mission. (The warming will still continue until power is turned off)</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        </div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    }</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    {</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        <span class="comment">// Now I need to compare the number of pulses I got with what I should have received</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        int8_t pulse_error = desired_pulses - pulse_count;   <span class="comment">// This will be able to handle negative numbers</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <span class="keywordtype">float</span> change = (float) pulse_error * V_per_pulse * ((<span class="keywordtype">float</span>) ICR1) / pump_tot_V;   <span class="comment">// Check page 94 in notebook for correct derivation.</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        OCR1B -= (uint16_t) change;   </div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        <span class="comment">// The above line should immediately change the PWM as well</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="keywordflow">if</span> (pulse_error &lt; 0)</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            pulse_error = -pulse_error;    <span class="comment">// Make it the absolute value </span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="keywordflow">if</span> (pulse_error &lt;= pulse_error_allow) <span class="comment">// mission is a success</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;            PORTD |= (1 &lt;&lt; Fuel_LED);        <span class="comment">// Make the fuel LED just stay on</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            PORTD ^= (1 &lt;&lt; Fuel_LED);       <span class="comment">// Make the fuel LED blink saying that it is not done yet.</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    </div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <span class="comment">// Now since some time has elapsed, toggle the Alive_LED</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        PORTD ^= (1 &lt;&lt; Alive_LED);       <span class="comment">// So the Alive_LED should blink on ~0.25 sec off ~0.25 sec</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    }</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;}</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno"><a class="line" href="a00005.html#ae058494623946a8ea13c1cdb69082dd3">  374</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a00002.html#ae058494623946a8ea13c1cdb69082dd3">ECU_toggle</a>(uint8_t ECU_mode)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;{</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTA, ECUon_Pin, ECU_mode);   <span class="comment">// make sure the ECU has its power circuit closed if it is an operational ECU</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;}</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00386"></a><span class="lineno"><a class="line" href="a00005.html#aba7fa75d6dd6ebcdc6225282a798fcd2">  386</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(<span class="keyword">volatile</span> uint8_t *sfr,uint8_t bit, uint8_t val)</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;{</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span> (val)      <span class="comment">// This is for if I want the value to be a 1</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    {</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        val = (val &lt;&lt; bit);</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        *sfr |= val;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    }</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">else</span>             <span class="comment">// This is for if I want the value to be a 0</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    {</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        val = ~(1 &lt;&lt; bit);</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        *sfr &amp;= val;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    }</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;}</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00405"></a><span class="lineno"><a class="line" href="a00005.html#af224025ba48225a48fc9eddc2e72150d">  405</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a00002.html#af224025ba48225a48fc9eddc2e72150d">change_timers</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;{</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    opMode = 1;                          <span class="comment">// Change the operational mode</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;PORTB,Warm_LED,1);    <span class="comment">// Turn on the LED to signal the heating sequence is complete</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <a class="code" href="a00002.html#ae058494623946a8ea13c1cdb69082dd3">ECU_toggle</a>(ECU_present);</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    </div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordflow">if</span> (!ECU_present)</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    {</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="comment">// First change Timer 1 to serve as the PWM output port for the pump</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TIMSK,TOIE1,0);    <span class="comment">// remove overflow interrupts for timer 1</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        TCCR1A |= (1 &lt;&lt; WGM11);     <span class="comment">// The sets one of the bits for the mode 14 waveform</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        TCCR1B |= (1 &lt;&lt; WGM12) | (1 &lt;&lt; WGM13);   <span class="comment">// This sets the other two bits for the waveform generation</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        TCCR1A |= (1 &lt;&lt; COM1B1) | (1 &lt;&lt; COM1B0);   <span class="comment">// These set the output mode</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        ICR1 = 20000;     <span class="comment">// this will set the period of oscillation to 20ms</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            </div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        OCR1B = ICR1 - (int)(ICR1*duty_cycle);     <span class="comment">// This will set the count at which the PWM will change to on. Also make sure to round down to int</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR1B, CS10, 1);              <span class="comment">// This should start the PWM with a prescalar of 1</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="comment">// Now the PWM should be running</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            </div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="comment">// Second change Timer 2 to serve as the counter for the pulse train from the flow meter</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0,CS02,0);</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0,CS01,0);</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        <a class="code" href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a>(&amp;TCCR0,CS00,0);     <span class="comment">// TThis will make sure that the timer is stopped for now    </span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        </div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="comment">// Third set the MCU Control and Status Register for the Interrupt Sense Control 2</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        MCUCSR |= (1 &lt;&lt; ISC2);         <span class="comment">// This will make interrupts occur on the rising edge, so the beginning of the pulse</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    }</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;}</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno"><a class="line" href="a00002.html#a30a0ad88a89a84c0161cf09eace108e8">  440</a></span>&#160;<a class="code" href="a00002.html#ab16889ae984b9b798989a0d239283cac">ISR</a>(INT2_vect)</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;{</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    pulse_count++;  <span class="comment">// The interrupt flag will automatically be cleared by hardware</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;}</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="ttc" id="a00002_html_ab42f8654f10b780bd735bb55bd53d60d"><div class="ttname"><a href="a00002.html#ab42f8654f10b780bd735bb55bd53d60d">tempConversion</a></div><div class="ttdeci">void tempConversion(void)</div><div class="ttdoc">Check for the completion of the ADC conversion, saves the result, and changes the channel...</div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00153">HCU_Funcs.c:153</a></div></div>
<div class="ttc" id="a00002_html_af224025ba48225a48fc9eddc2e72150d"><div class="ttname"><a href="a00002.html#af224025ba48225a48fc9eddc2e72150d">change_timers</a></div><div class="ttdeci">void change_timers(void)</div><div class="ttdoc">Changes the mode of the used timers such that they can perform new functions in the pumping phase of ...</div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00405">HCU_Funcs.c:405</a></div></div>
<div class="ttc" id="a00002_html_aba7fa75d6dd6ebcdc6225282a798fcd2"><div class="ttname"><a href="a00002.html#aba7fa75d6dd6ebcdc6225282a798fcd2">assign_bit</a></div><div class="ttdeci">void assign_bit(volatile uint8_t *sfr, uint8_t bit, uint8_t val)</div><div class="ttdoc">Sets the specified bit to the specified value or does nothing if it already set to that...</div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00386">HCU_Funcs.c:386</a></div></div>
<div class="ttc" id="a00002_html_a7eb1892912f647fc11a82891ac8b0408"><div class="ttname"><a href="a00002.html#a7eb1892912f647fc11a82891ac8b0408">tempHeaterHelper</a></div><div class="ttdeci">void tempHeaterHelper(void)</div><div class="ttdoc">Checks the recorded temperatures and ensures there is no overheating. </div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00208">HCU_Funcs.c:208</a></div></div>
<div class="ttc" id="a00002_html_ab16889ae984b9b798989a0d239283cac"><div class="ttname"><a href="a00002.html#ab16889ae984b9b798989a0d239283cac">ISR</a></div><div class="ttdeci">ISR(TIMER1_OVF_vect)</div><div class="ttdoc">Interrupt service routine for the timer which controls the alive LED and warming LED. </div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00122">HCU_Funcs.c:122</a></div></div>
<div class="ttc" id="a00002_html_ae058494623946a8ea13c1cdb69082dd3"><div class="ttname"><a href="a00002.html#ae058494623946a8ea13c1cdb69082dd3">ECU_toggle</a></div><div class="ttdeci">void ECU_toggle(uint8_t ECU_mode)</div><div class="ttdoc">Checks if the ECU power circuit is closed and if it is not, it opens it. </div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00374">HCU_Funcs.c:374</a></div></div>
<div class="ttc" id="a00005_html"><div class="ttname"><a href="a00005.html">HCU_Funcs.h</a></div><div class="ttdoc">Function prototypes for the HCU Master Microcontroller. </div></div>
<div class="ttc" id="a00002_html_a560b1b76f46bf0b687417029801fd05a"><div class="ttname"><a href="a00002.html#a560b1b76f46bf0b687417029801fd05a">flowMeter</a></div><div class="ttdeci">void flowMeter(void)</div><div class="ttdoc">Reads/times the pulse train coming from the flow meter and passes this to pumpOperation. </div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00324">HCU_Funcs.c:324</a></div></div>
<div class="ttc" id="a00005_html_ad188fb0fbfd923bdb01294072367d024"><div class="ttname"><a href="a00005.html#ad188fb0fbfd923bdb01294072367d024">bit_is_clear</a></div><div class="ttdeci">#define bit_is_clear(sfr, bit)</div><div class="ttdoc">Simple function define for testing if the bit is clear. </div><div class="ttdef"><b>Definition:</b> <a href="a00005_source.html#l00025">HCU_Funcs.h:25</a></div></div>
<div class="ttc" id="a00002_html_a23459ced73501cbafb717ca9cbb10ce7"><div class="ttname"><a href="a00002.html#a23459ced73501cbafb717ca9cbb10ce7">Initial</a></div><div class="ttdeci">void Initial(void)</div><div class="ttdoc">Initializes the microcontroller for its mainline execution. </div><div class="ttdef"><b>Definition:</b> <a href="a00002_source.html#l00036">HCU_Funcs.c:36</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_719074a17a7794203581cf1f65f2001a.html">CU-Boulder Senior Year</a></li><li class="navelem"><a class="el" href="dir_157e784a2d29d59c28969bcf4fb10ab9.html">Senior Projects</a></li><li class="navelem"><a class="el" href="dir_15fff86b7ab2a99e1ef3f8ea095a17c3.html">ACES_HCU</a></li><li class="navelem"><a class="el" href="dir_2827894691d6dc0f03d6c010d3852b7a.html">ACES_HCU</a></li><li class="navelem"><a class="el" href="a00002.html">HCU_Funcs.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
